<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Nh·∫≠p Kho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</head>

<style>
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .ui-menu-item {
        padding: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    .ui-menu-item:hover {
        background: #f0f0f0;
    }

    .overflow-x-auto {
        position: relative;
        margin: 0 auto;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table-fixed {
        table-layout: fixed;
    }

    td,
    th {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    td input,
    td select {
        width: 100%;
        min-width: 0;
        box-sizing: border-box;
    }

    td select {
        padding-right: 20px;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
        margin: 0 auto;
    }

    .responsive-table {
        min-width: 100%;
        border-collapse: collapse;
    }

    .responsive-table th,
    .responsive-table td {
        white-space: nowrap;
        padding: 0.5rem;
        text-align: left;
    }

    .responsive-table th.ten-hang-col,
    .responsive-table td.ten-hang-col {
        min-width: 200px;
        max-width: none;
    }

    @media (max-width: 768px) {

        .responsive-table th.ten-hang-col,
        .responsive-table td.ten-hang-col {
            min-width: 150px;
        }
    }

    @media (max-width: 640px) {
        .table-container::-webkit-scrollbar {
            -webkit-appearance: none;
            height: 7px;
        }

        .table-container::-webkit-scrollbar-thumb {
            border-radius: 4px;
            background-color: rgba(0, 0, 0, .3);
        }
    }
</style>

<body class="bg-gradient-to-br from-blue-50 to-blue-100 p-4">
    <!-- Ki·ªÉm tra ƒëƒÉng nh·∫≠p + n√∫t ƒëƒÉng xu·∫•t -->
    <script>
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'https://tambv25.github.io/NhapKho/login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', checkAuth);

        // Th√™m n√∫t ƒëƒÉng xu·∫•t v√†o header
        window.addEventListener('load', function () {
            const header = document.querySelector('.flex.justify-between.items-center.mb-3');
            if (header) {
                const logoutButton = document.createElement('button');
                logoutButton.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded font-medium text-sm ml-2';
                logoutButton.innerHTML = '‚ü≤ ƒêƒÉng xu·∫•t';
                logoutButton.onclick = function () {
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('userData');
                    window.location.href = 'https://tambv25.github.io/NhapKho/login.html';
                };

                const buttonContainer = header.querySelector('.flex.gap-2');
                if (buttonContainer) {
                    buttonContainer.appendChild(logoutButton);
                }
            }
        });
    </script>

    <div class="max-w-8xl mx-auto">
        <form id="inventoryForm" class="bg-white rounded-lg shadow-md p-4 mb-4 animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-bold text-gray-800">Phi·∫øu Nh·∫≠p Kho</h1>
                <div class="flex gap-2">
                    <button type="submit"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded font-medium text-sm">‚úì
                        L∆∞u</button>
                    <button type="button" onclick="resetForm()"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1.5 rounded font-medium text-sm">‚Ü∫
                        L√†m m·ªõi</button>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-3">
                <!-- Left Column -->
                <div class="col-span-8 grid gap-3">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">S·ªë phi·∫øu</label>
                            <input type="text" id="id" class="w-full border rounded p-1.5 text-sm" value="PNK000">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-600">M√£ NCC</label>
                            <input type="text" id="maNCC" class="w-full border rounded p-1.5 text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">T√™n NCC</label>
                            <input type="text" id="tenNCC" class="w-full border rounded p-1.5 text-sm bg-gray-50"
                                readonly>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Ng√†y Th√°ng</label>
                            <input type="date" id="ngayThang" class="w-full border rounded p-1.5 text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">M√£ H√†ng</label>
                            <input type="text" id="maHang" class="w-full border rounded p-1.5 text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">T√™n H√†ng</label>
                            <input type="text" id="tenHang" class="w-full border rounded p-1.5 text-sm bg-gray-50"
                                readonly>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">S·ªë Lot</label>
                            <input type="text" id="soLot" class="w-full border rounded p-1.5 text-sm" value="Lot000">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">S·ªë Hƒê</label>
                            <input type="text" id="soHD" class="w-full border rounded p-1.5 text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">S·ªë PO#</label>
                            <input type="text" id="soPO" class="w-full border rounded p-1.5 text-sm">
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-span-4 grid gap-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">NSX</label>
                            <input type="date" id="nsx" class="w-full border rounded p-1.5 text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">HSD</label>
                            <input type="date" id="hsd" class="w-full border rounded p-1.5 text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">S·ªë L∆∞·ª£ng</label>
                            <input type="number" id="soLuong" class="w-full border rounded p-1.5 text-sm" step="0.01"
                                min="0">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">V·ªã Tr√≠</label>
                            <input type="text" id="viTri" class="w-full border rounded p-1.5 text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Ghi Ch√∫</label>
                            <input type="text" id="ghiChu" class="w-full border rounded p-1.5 text-sm">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <br>

    <div class="max-w-8xl mx-auto space-y-6">
        <!-- Temporary Table Card -->
        <div class="bg-white rounded-xl shadow-lg p-4 animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">B·∫£ng T·∫°m</h2>
                <div class="flex gap-2">
                    <a href="https://tambv25.github.io/NhapKho/inlaber.html" target="_blank"
                        class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg">
                        üñ®Ô∏è In phi·∫øu
                    </a>
                    <button onclick="saveToAppSheet()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg">
                        L∆∞u v√†o CSDL
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="responsive-table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 120px;">
                                Tr·∫°ng Th√°i
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 120px;">
                                M√£ H√†ng
                            </th>
                            <th
                                class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider ten-hang-col">
                                T√™n H√†ng
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 90px; width: 90px;">
                                S·ªë L∆∞·ª£ng
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 100px; width: 100px;">
                                V·ªã Tr√≠
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 120px; width: 120px;">
                                NSX
                            </th>
                            <th class="px-2 py-3 tetext-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 120px; width: 120px;">
                                HSD
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 150px; width: 150px;">
                                S·ªë Lot
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 150px; width: 150px;">
                                Ghi Ch√∫
                            </th>
                            <th class="px-2 py-3 text-xs font-semibold text-gray-600 uppercase tracking-wider"
                                style="min-width: 60px; width: 60px;">
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tempTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal"
            class="fixed inset-0 bg-gray-600/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
            <div
                class="bg-white rounded-xl shadow-2xl p-8 w-[600px] max-w-[90%] transform transition-all animate__animated animate__fadeInUp">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Ch·ªânh S·ª≠a D√≤ng</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="editForm" class="space-y-6">
                    <input type="hidden" id="editIndex">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">S·ªë L∆∞·ª£ng</label>
                            <input type="number" id="editSoLuong"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">NSX</label>
                            <input type="date" id="editNSX"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">HSD</label>
                            <input type="date" id="editHSD"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">S·ªë Lot</label>
                            <input type="text" id="editSoLot"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ghi Ch√∫</label>
                            <input type="text" id="editGhiChu"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">V·ªã Tr√≠</label>
                            <input type="text" id="editViTri"
                                class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-6">
                        <button type="button" onclick="closeEditModal()"
                            class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-colors">
                            H·ªßy
                        </button>
                        <button type="submit"
                            class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors shadow-lg hover:shadow-xl">
                            L∆∞u
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay"
            class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 flex flex-col items-center animate__animated animate__fadeIn">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-lg font-medium text-gray-700">ƒêang x·ª≠ l√Ω...</p>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage"
            class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden animate__animated">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>Thao t√°c th√†nh c√¥ng!</span>
            </div>
        </div>

        <script>
            // Ch·∫∑n chu·ªôt ph·∫£i + ph√≠m t·∫Øt DevTools
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
            }, false);

            document.onkeydown = function (e) {
                if (e.keyCode == 123) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
            };

            function showLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }

            function hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }

            function showSuccess(message = 'Thao t√°c th√†nh c√¥ng!') {
                const successMsg = document.getElementById('successMessage');
                successMsg.querySelector('span').textContent = message;
                successMsg.classList.remove('hidden');
                successMsg.classList.add('animate__slideInRight');

                setTimeout(() => {
                    successMsg.classList.remove('animate__slideInRight');
                    successMsg.classList.add('animate__slideOutRight');

                    setTimeout(() => {
                        successMsg.classList.add('hidden');
                        successMsg.classList.remove('animate__slideOutRight');
                    }, 500);
                }, 3000);
            }

            // AppSheet API
            const appId = 'cb939a9d-a524-4bdf-9035-71ed0ab962d4';
            const accessKey = 'V2-fJCAe-tBC2O-bx4Ky-7ECei-IL1aw-E0j4S-HW352-yq1kE';
            const region = 'www';

            function apiRequest(tableName, action, data) {
                const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
                return $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        Action: action,
                        Properties: {
                            Locale: 'vi-VN',
                            Timezone: 'Asia/Ho_Chi_Minh'
                        },
                        ...data
                    })
                }).then(response => response)
                    .catch(error => { throw error; });
            }

            const temporaryData = [];
            let currentUser = '';

            async function saveToAppSheet() {
                try {
                    if (temporaryData.length === 0) {
                        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
                        return;
                    }
                    showLoading();

                    const currentSoPhieu = document.getElementById('id').value;

                    // L·∫•y ƒë·ªãa ch·ªâ NCC t·ª´ DanhMuc_NCC_2 (n·∫øu c√≥ c·ªôt n√†y)
                    let diaChiNCC = '';
                    try {
                        const nccResponse = await apiRequest('DanhMuc_NCC_2', 'Find', {
                            Selector: {
                                Filter: `[_THISROW].[%5BM%C3%A3%20NCC%5D = '${document.getElementById('maNCC').value}'`
                            }
                        });
                        // N·∫øu b·∫°n c√≥ c·ªôt ƒë·ªãa ch·ªâ, ƒë·ªïi 'ƒê·ªãa ch·ªâ' ƒë√∫ng t√™n c·ªôt th·ª±c t·∫ø
                        if (Array.isArray(nccResponse) && nccResponse.length > 0) {
                            diaChiNCC = nccResponse[0]['ƒê·ªãa ch·ªâ'] || '';
                        }
                    } catch (error) {
                        console.error('L·ªói khi l·∫•y ƒë·ªãa ch·ªâ NCC:', error);
                    }

                    const detailRecords = temporaryData.map(item => ({
                        NGAY_THANG: item.ngayThang,
                        "S·ªë Hƒê": item.soHD,
                        "S·ªë PO#": item.soPO,
                        TRANG_THAI: item.trangThai,
                        SO_PHIEU: currentSoPhieu,
                        MA_HANG: item.maHang,
                        SO_LUONG: item.soLuong.toString().replace('.', ','),
                        NSX: item.nsx,
                        HSD: item.hsd,
                        SO_LOT: item.soLot,
                        TEN_NCC: item.tenNCC,
                        GHI_CHU: item.ghiChu,
                        VI_TRI: item.viTri,
                        DON_GIA: item.donGia,
                        THANH_TIEN: (item.donGia * item.soLuong).toString().replace('.', ','),
                        KHO: "Kho Qu·∫•t ƒê·ªông",
                        NHOM_HANG: item.nhomHang
                    }));

                    const tongSoLuong = temporaryData.reduce((sum, item) => sum + Number(item.soLuong), 0);
                    const tongTien = temporaryData.reduce((sum, item) => sum + (Number(item.donGia) * Number(item.soLuong)), 0);
                    const uniqueNhomHang = [...new Set(temporaryData.map(item => item.nhomHang))].join(', ');

                    const trangThai = temporaryData.every(item => item.trangThai === 'Ho√†n th√†nh') ? 'Ho√†n th√†nh' : 'T·∫°o m·ªõi';

                    const summaryData = {
                        Rows: [{
                            TRANG_THAI: trangThai,
                            SO_PHIEU: currentSoPhieu,
                            NGAY_THANG: document.getElementById('ngayThang').value,
                            TEN_NCC: document.getElementById('tenNCC').value,
                            DIA_CHI: diaChiNCC,
                            NHOM_HANG: uniqueNhomHang,
                            SO_HD: document.getElementById('soHD').value,
                            "SO_PO#": document.getElementById('soPO').value,
                            GHI_CHU: document.getElementById('ghiChu').value,
                            SO_LUONG: tongSoLuong.toString().replace('.', ','),
                            "TONG TIEN": tongTien.toString().replace('.', ','),
                            NGUOI_TAO: currentUser
                        }]
                    };

                    await apiRequest('NhapKho_CT', 'Add', { Rows: detailRecords });
                    await apiRequest('NhapKho', 'Add', summaryData);

                    temporaryData.length = 0;
                    document.getElementById('tempTableBody').innerHTML = '';
                    document.getElementById('inventoryForm').reset();

                    const result = await generateNextId();
                    if (result) {
                        document.getElementById('id').value = result.id;
                        document.getElementById('soLot').value = result.soLot;
                    }

                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('ngayThang').value = today;

                    hideLoading();
                    showSuccess('L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!');
                } catch (error) {
                    console.error('L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
                    hideLoading();
                    alert('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message);
                }
            }

            function updateTempTable() {
                const tableBody = document.getElementById('tempTableBody');
                tableBody.innerHTML = '';

                temporaryData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 py-4">
                            <select class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'trangThai', this.value)">
                                <option value="T·∫°o m·ªõi" ${item.trangThai === 'T·∫°o m·ªõi' ? 'selected' : ''}>T·∫°o m·ªõi</option>
                                <option value="Ho√†n th√†nh" ${item.trangThai === 'Ho√†n th√†nh' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            </select>
                        </td>
                        <td class="px-2 py-4 text-center">${item.maHang}</td>
                        <td class="px-2 py-4 text-center">${item.tenHang}</td>
                        <td class="px-2 py-4 text-center">
                            <input type="text"
                                value="${item.soLuong.toString().replace('.', ',')}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500 font-bold text-blue-600"
                                onchange="updateField(${index}, 'soLuong', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <input type="text" value="${item.viTri}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'viTri', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <input type="date" value="${item.nsx}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'nsx', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <input type="date" value="${item.hsd}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'hsd', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <input type="text" value="${item.soLot}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'soLot', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <input type="text" value="${item.ghiChu}"
                                class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500"
                                onchange="updateField(${index}, 'ghiChu', this.value)">
                        </td>
                        <td class="px-2 py-4 text-center">
                            <button onclick="deleteRow(${index})"
                                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">
                                ‚úï
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            function updateField(index, field, value) {
                if (field === 'soLuong') {
                    temporaryData[index][field] = parseFloat(value.replace(',', '.'));
                } else {
                    temporaryData[index][field] = value;
                }

                if (field === 'viTri') {
                    temporaryData[index].trangThai = value.trim() ? 'Ho√†n th√†nh' : 'T·∫°o m·ªõi';
                }

                updateTempTable();
                showSuccess('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
            }

            function deleteRow(index) {
                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng n√†y?')) {
                    temporaryData.splice(index, 1);
                    updateTempTable();
                }
            }

            document.getElementById('editForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const index = document.getElementById('editIndex').value;

                temporaryData[index] = {
                    ...temporaryData[index],
                    soLuong: parseInt(document.getElementById('editSoLuong').value),
                    nsx: document.getElementById('editNSX').value,
                    hsd: document.getElementById('editHSD').value,
                    soLot: document.getElementById('editSoLot').value,
                    ghiChu: document.getElementById('editGhiChu').value,
                    viTri: document.getElementById('editViTri').value
                };

                updateTempTable();
                closeEditModal();
            });

            // Submit form nh·∫≠p m·ªôt m√£ h√†ng
            document.getElementById('inventoryForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const maHang = document.getElementById('maHang').value;
                const soLuong = parseFloat(document.getElementById('soLuong').value || '0');

                if (!maHang.trim()) {
                    alert('Vui l√≤ng nh·∫≠p m√£ h√†ng');
                    document.getElementById('maHang').focus();
                    return;
                }

                if (!soLuong || soLuong <= 0) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá');
                    document.getElementById('soLuong').focus();
                    return;
                }

                try {
                    const response = await apiRequest('DanhMuc_HH', 'Find', {
                        Selector: {
                            Columns: ["MA_HANG", "TEN_HANG", "So luong/1 Pallet", "ƒê∆°n Gi√°", "Nh√≥m H√†ng"]
                        }
                    });

                    if (!Array.isArray(response) || response.length === 0) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y danh s√°ch s·∫£n ph·∫©m');
                    }

                    const product = response.find(item => item.MA_HANG === maHang);
                    if (product) {
                        const palletQuantity = parseFloat(product['So luong/1 Pallet']);

                        if (!palletQuantity || palletQuantity <= 0) {
                            alert(`M√£ h√†ng ${maHang} ch∆∞a c√≥ th√¥ng tin S·ªë l∆∞·ª£ng/1 Pallet. Vui l√≤ng c·∫≠p nh·∫≠t th√¥ng tin tr∆∞·ªõc khi nh·∫≠p kho.`);
                            return;
                        }

                        const formData = {
                            id: document.getElementById('id').value,
                            ngayThang: document.getElementById('ngayThang').value,
                            soHD: document.getElementById('soHD').value,
                            soPO: document.getElementById('soPO').value,
                            maHang: maHang,
                            tenHang: document.getElementById('tenHang').value,
                            soLuong: parseFloat(soLuong.toFixed(2)),
                            nsx: document.getElementById('nsx').value,
                            hsd: document.getElementById('hsd').value,
                            soLot: document.getElementById('soLot').value,
                            tenNCC: document.getElementById('tenNCC').value,
                            ghiChu: document.getElementById('ghiChu').value,
                            viTri: document.getElementById('viTri').value,
                            trangThai: document.getElementById('viTri').value.trim() ? 'Ho√†n th√†nh' : 'T·∫°o m·ªõi'
                        };

                        const donGia = parseFloat(product['ƒê∆°n Gi√°']) || 0;
                        const nhomHang = product['Nh√≥m H√†ng'] || '';

                        const totalEntries = Math.ceil(formData.soLuong / palletQuantity);
                        let remainingQuantity = formData.soLuong;

                        for (let i = 0; i < totalEntries; i++) {
                            const currentQuantity = Math.min(remainingQuantity, palletQuantity);
                            remainingQuantity -= currentQuantity;

                            const entryData = {
                                ...formData,
                                soLuong: parseFloat(currentQuantity.toFixed(2)),
                                soLot: `${formData.soLot}_P${i + 1}`,
                                donGia: donGia,
                                nhomHang: nhomHang
                            };
                            temporaryData.push(entryData);
                        }

                        updateTempTable();
                        showSuccess('Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!');

                        document.getElementById('maHang').value = '';
                        document.getElementById('tenHang').value = '';
                        document.getElementById('soLuong').value = '';
                        document.getElementById('maHang').focus();
                    }
                } catch (error) {
                    console.error('L·ªói:', error);
                    alert(error.message);
                }
            });

            function resetForm() {
                document.getElementById('maHang').value = '';
                document.getElementById('tenHang').value = '';
                document.getElementById('soLuong').value = '';
                document.getElementById('viTri').value = '';
                document.getElementById('ghiChu').value = '';
                document.getElementById('maNCC').value = '';
                document.getElementById('tenNCC').value = '';
                document.getElementById('soHD').value = '';
                document.getElementById('soPO').value = '';
                document.getElementById('hsd').value = '';
                document.getElementById('nsx').value = '';
                document.getElementById('ngayThang').value = new Date().toISOString().split('T')[0];
            }

            // ---------- PH·∫¶N NCC: DanhMuc_NCC_2, c·ªôt "M√£ NCC" & "T√™n NCC_PM" ----------

            // T√¨m NCC theo c·ªôt "M√£ NCC"
            async function searchNCC(maNCC) {
                try {
                    const response = await apiRequest('DanhMuc_NCC_2', 'Find', {
                        Selector: {
                            Filter: `[%5BM%C3%A3%20NCC%5D = '${maNCC}'`
                        }
                    });

                    if (Array.isArray(response) && response.length > 0) {
                        const ncc = response[0];
                        document.getElementById('tenNCC').value = ncc['T√™n NCC_PM'] || '';
                    } else {
                        document.getElementById('tenNCC').value = '';
                        alert('Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p v·ªõi m√£ n√†y');
                    }
                } catch (error) {
                    console.error('Error searching NCC:', error);
                    alert('L·ªói khi t√¨m ki·∫øm nh√† cung c·∫•p: ' + error.message);
                }
            }

            // T√¨m s·∫£n ph·∫©m theo m√£ (gi·ªØ nguy√™n)
            async function searchProduct(maHang) {
                try {
                    const palletQuantityAttr = $("#maHang").attr('data-pallet-quantity');
                    if (palletQuantityAttr) {
                        return {
                            palletQuantity: parseInt(palletQuantityAttr),
                            donGia: parseFloat($("#maHang").attr('data-don-gia'))
                        };
                    }

                    const response = await apiRequest('DanhMuc_HH', 'Find', {
                        Selector: {
                            Filter: `[MA_HANG] = '${maHang}'`
                        }
                    });

                    if (Array.isArray(response) && response.length > 0) {
                        const product = response[0];
                        document.getElementById('tenHang').value = product.TEN_HANG;
                        return {
                            palletQuantity: parseInt(product['So luong/1 Pallet']) || 0,
                            donGia: parseFloat(product['ƒê∆°n Gi√°']) || 0
                        };
                    } else {
                        alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi m√£ n√†y');
                        return null;
                    }
                } catch (error) {
                    console.error('L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m:', error);
                    alert('L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m: ' + error.message);
                    return null;
                }
            }

            // Load to√†n b·ªô NCC t·ª´ b·∫£ng DanhMuc_NCC_2
            async function loadAllNCC() {
                try {
                    const response = await apiRequest('DanhMuc_NCC_2', 'Find', {
                        Selector: {
                            Columns: ["M√£ NCC", "T√™n NCC_PM"]
                        }
                    });

                    if (Array.isArray(response) && response.length > 0) {
                        const nccData = response.map(ncc => ({
                            value: ncc['M√£ NCC'],
                            label: `${ncc['M√£ NCC']} - ${ncc['T√™n NCC_PM']}`,
                            tenNCC_PM: ncc['T√™n NCC_PM']
                        }));

                        $("#maNCC").autocomplete({
                            source: nccData,
                            minLength: 0,
                            select: function (event, ui) {
                                $("#maNCC").val(ui.item.value);
                                $("#tenNCC").val(ui.item.tenNCC_PM);
                                setTimeout(() => {
                                    $("#maHang").focus();
                                }, 50);
                                return false;
                            }
                        }).focus(function () {
                            $(this).autocomplete("search", "");
                        });
                    }
                } catch (error) {
                    console.error("Error loading NCC:", error);
                }
            }

            // Load to√†n b·ªô s·∫£n ph·∫©m
            async function loadAllProducts() {
                try {
                    const response = await apiRequest('DanhMuc_HH', 'Find', {
                        Selector: {
                            Columns: ["MA_HANG", "TEN_HANG", "So luong/1 Pallet", "ƒê∆°n Gi√°"]
                        }
                    });

                    if (Array.isArray(response) && response.length > 0) {
                        const productData = response.map(product => ({
                            value: product.MA_HANG,
                            label: `${product.MA_HANG} - ${product.TEN_HANG}`,
                            tenHang: product.TEN_HANG,
                            palletQuantity: product['So luong/1 Pallet'],
                            donGia: product['ƒê∆°n Gi√°']
                        }));

                        $("#maHang").autocomplete({
                            source: productData,
                            minLength: 0,
                            select: function (event, ui) {
                                $("#maHang").val(ui.item.value);
                                $("#tenHang").val(ui.item.tenHang);
                                $("#maHang").attr('data-pallet-quantity', ui.item.palletQuantity);
                                $("#maHang").attr('data-don-gia', ui.item.donGia);
                                setTimeout(() => {
                                    $("#soLuong").focus();
                                }, 100);
                                return false;
                            }
                        }).focus(function () {
                            $(this).autocomplete("search", "");
                        });
                    }
                } catch (error) {
                    console.error("Error loading Products:", error);
                }
            }

            // Khi ng∆∞·ªùi d√πng g√µ tay M√£ NCC
            document.getElementById('maNCC').addEventListener('change', function () {
                const maNCC = this.value.trim();
                if (maNCC) {
                    searchNCC(maNCC);
                } else {
                    document.getElementById('tenNCC').value = '';
                }
            });

            // Khi ng∆∞·ªùi d√πng g√µ tay M√£ h√†ng
            document.getElementById('maHang').addEventListener('change', async function () {
                const maHang = this.value;
                if (maHang) {
                    await searchProduct(maHang);
                }
            });

            async function generateNextId() {
                try {
                    const now = new Date();
                    const year = now.getFullYear().toString().slice(-2);
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const seconds = now.getSeconds().toString().padStart(2, '0');

                    const timestamp = `${year}${month}${day}_${hours}${minutes}${seconds}`;
                    return {
                        id: `PNK${timestamp}`,
                        soLot: `LOT${timestamp}`
                    };
                } catch (error) {
                    console.error('L·ªói khi t·∫°o ID:', error);
                    return null;
                }
            }

            function updateIdPeriodically() {
                const idField = document.getElementById('id');
                const soLotField = document.getElementById('soLot');
                if (idField && soLotField) {
                    generateNextId().then(result => {
                        if (result) {
                            idField.value = result.id;
                            soLotField.value = result.soLot;
                        }
                    });
                }
            }

            // L·∫•y currentUser t·ª´ sessionStorage
            document.addEventListener('DOMContentLoaded', function () {
                const userData = sessionStorage.getItem('userData');
                if (userData) {
                    try {
                        const userObj = JSON.parse(userData);
                        currentUser = userObj.TEN_NV || 'Unknown';
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                        currentUser = 'Unknown';
                    }
                }
            });

            // Thi·∫øt l·∫≠p ng√†y, ID, Lot, v√† load autocomplete
            document.addEventListener('DOMContentLoaded', async function () {
                const today = new Date().toISOString().split('T')[0];
                const ngayThangInput = document.getElementById('ngayThang');
                if (ngayThangInput) ngayThangInput.value = today;

                const result = await generateNextId();
                if (result) {
                    document.getElementById('id').value = result.id;
                    document.getElementById('soLot').value = result.soLot;
                }

                document.getElementById('id').readOnly = true;
                document.getElementById('id').classList.add('bg-gray-50');

                setInterval(updateIdPeriodically, 1000);
            });

            $(document).ready(function () {
                loadAllProducts();
                loadAllNCC();
            });
        </script>
</body>

</html>
